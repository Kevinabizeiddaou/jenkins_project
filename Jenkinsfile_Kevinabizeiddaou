pipeline {
  agent any
  options { ansiColor('xterm') }

  environment {
    PYTHON_EXE = 'C:\\Program Files\\Python313\\python.exe'
  }

  stages {
    stage('Setup') {
      steps {
        bat '''
          rem Always start clean to avoid old/bad venvs
          if exist "venv" rmdir /s /q "venv"

          "%PYTHON_EXE%" -m venv "venv"
          "venv\\Scripts\\python" -c "import sys; print('VENV PY:', sys.executable)"

          "venv\\Scripts\\python" -m pip install --upgrade pip
          "venv\\Scripts\\python" -m pip install -r requirements.txt
        '''
      }
    }

    stage('Lint') {
      steps {
        bat '"venv\\Scripts\\python" -m flake8 app.py'
      }
    }

    stage('Test') {
      steps {
        bat 'set "PYTHONPATH=%CD%" && "venv\\Scripts\\python" -m pytest -q --junitxml=pytest-report.xml'
      }
    }

    stage('Coverage') {
      steps {
        bat '''
          set "PYTHONPATH=%CD%"
          "venv\\Scripts\\python" -m coverage run -m pytest
          "venv\\Scripts\\python" -m coverage html
          "venv\\Scripts\\python" -m coverage report
        '''
      }
    }

    stage('Security Scan') {
        steps {
            bat '"venv\\Scripts\\python" -m bandit -r . -x venv,tests,__pycache__,node_modules -f html -o bandit-report.html --exit-zero'
        }
    }


    stage('Deploy') {
      steps {
        bat 'powershell -NoProfile -Command "Compress-Archive -Path app.py -DestinationPath build-artifact.zip -Force"'
      }
    }
  }

  post {
    always {
      junit allowEmptyResults: true, testResults: 'pytest-report.xml'
      script {
        if (fileExists('htmlcov/index.html')) {
          publishHTML(target: [reportName: 'Coverage Report', reportDir: 'htmlcov', reportFiles: 'index.html', keepAll: true, alwaysLinkToLastBuild: true])
        }
        if (fileExists('bandit-report.html')) {
          publishHTML(target: [reportName: 'Bandit Security Report', reportDir: '.', reportFiles: 'bandit-report.html', keepAll: true, alwaysLinkToLastBuild: true])
        }
      }
      cleanWs()
    }
  }
}