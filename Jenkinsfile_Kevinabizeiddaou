pipeline {
  agent any

  options {
    ansiColor('xterm')
    timestamps()
  }

  environment {
    VENV_DIR = 'venv'      // virtualenv directory inside WORKSPACE
    PY = 'python'          // 'python3' if your agent needs it
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Setup') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              [ -d "${VENV_DIR}" ] || ${PY} -m venv ${VENV_DIR}
              . ${VENV_DIR}/bin/activate
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            """
          } else {
            bat """
              if not exist ${VENV_DIR} ( ${PY} -m venv ${VENV_DIR} )
              call ${VENV_DIR}\\Scripts\\activate
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            """
          }
        }
      }
    }

    stage('Lint') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              flake8 app.py
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              flake8 app.py
            """
          }
        }
      }
    }

    stage('Test') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              pytest --maxfail=1 --disable-warnings -q
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              pytest --maxfail=1 --disable-warnings -q
            """
          }
        }
      }
    }

    stage('Coverage') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              coverage erase
              coverage run -m pytest
              coverage report -m
              coverage html -d coverage_html
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              coverage erase
              coverage run -m pytest
              coverage report -m
              coverage html -d coverage_html
            """
          }
        }
      }
      post {
        always {
          publishHTML(target: [
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: 'coverage_html',
            reportFiles: 'index.html',
            reportName: 'Coverage Report'
          ])
        }
      }
    }

    stage('Security Scan') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              bandit -r . -x ${VENV_DIR} -f txt -o bandit_report.txt || true
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              bandit -r . -x ${VENV_DIR} -f txt -o bandit_report.txt || exit /b 0
            """
          }
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit_report.txt', onlyIfSuccessful: false
        }
      }
    }

    stage('Package') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              ${env.PY} scripts/package_app.py
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              ${env.PY} scripts\\package_app.py
            """
          }
        }
      }
      post {
        success {
          archiveArtifacts artifacts: 'dist/**', fingerprint: true
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          if (isUnix()) {
            sh """
              set -e
              . ${VENV_DIR}/bin/activate
              bash scripts/deploy_local.sh
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\activate
              powershell -ExecutionPolicy Bypass -File scripts\\deploy_local.ps1
            """
          }
        }
      }
    }
  }

  post {
    always {
      cleanWs(deleteDirs: true, notFailBuild: true)
    }
  }
}