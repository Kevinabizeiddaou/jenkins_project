pipeline {
  agent any
  environment {
    VENV_DIR = '.venv'
    PY = isUnix() ? 'python3' : 'py -3'
  }

  options {
    // leave empty (no ansiColor)
    // you can also add: disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Setup') {
      steps {
        script {
          if (isUnix()) {
            sh """
              ${PY} -m venv ${VENV_DIR}
              ${VENV_DIR}/bin/python -m pip install --upgrade pip
              ${VENV_DIR}/bin/pip install -r requirements.txt
            """
          } else {
            bat """
              ${PY} -m venv ${VENV_DIR}
              call ${VENV_DIR}\\Scripts\\python -m pip install --upgrade pip
              call ${VENV_DIR}\\Scripts\\pip install -r requirements.txt
            """
          }
        }
      }
    }

    stage('Lint') {
      steps {
        script {
          if (isUnix()) sh "${VENV_DIR}/bin/flake8 app.py"
          else bat "call ${VENV_DIR}\\Scripts\\flake8 app.py"
        }
      }
    }

    stage('Test') {
      steps {
        script {
          if (isUnix()) sh "${VENV_DIR}/bin/pytest -q"
          else bat "call ${VENV_DIR}\\Scripts\\pytest -q"
        }
      }
    }

    stage('Coverage') {
      steps {
        script {
          if (isUnix()) {
            sh """
              ${VENV_DIR}/bin/coverage erase
              ${VENV_DIR}/bin/coverage run -m pytest
              ${VENV_DIR}/bin/coverage html -d coverage_html
            """
          } else {
            bat """
              call ${VENV_DIR}\\Scripts\\coverage erase
              call ${VENV_DIR}\\Scripts\\coverage run -m pytest
              call ${VENV_DIR}\\Scripts\\coverage html -d coverage_html
            """
          }
        }
      }
      post {
        always {
          publishHTML(target: [
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: 'coverage_html',
            reportFiles: 'index.html',
            reportName: 'Coverage Report'
          ])
        }
      }
    }

    stage('Security Scan') {
      steps {
        script {
          if (isUnix()) {
            sh "${VENV_DIR}/bin/bandit -r . -x ${VENV_DIR} -f txt -o bandit_report.txt || true"
          } else {
            bat "call ${VENV_DIR}\\Scripts\\bandit -r . -x ${VENV_DIR} -f txt -o bandit_report.txt || exit /b 0"
          }
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit_report.txt', onlyIfSuccessful: false
        }
      }
    }

    stage('Package') {
      steps {
        script {
          if (isUnix()) {
            sh "${VENV_DIR}/bin/python scripts/package_app.py"
          } else {
            bat "call ${VENV_DIR}\\Scripts\\python scripts\\package_app.py"
          }
        }
      }
      post {
        success {
          archiveArtifacts artifacts: 'dist/**', fingerprint: true
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          if (isUnix()) {
            sh "bash scripts/deploy_local.sh"
          } else {
            bat "powershell -ExecutionPolicy Bypass -File scripts\\deploy_local.ps1"
          }
        }
      }
    }
  }

  post {
    always { cleanWs(deleteDirs: true, notFailBuild: true) }
  }
}
